{% extends 'core/base.html' %}

{% block content %}
<div class="header">
    <div>
        <h1 class="page-title">Inventario</h1>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">
            Valor Total: <span id="total-inventory-value" style="font-weight: 700; color: var(--text-main);">
                ${{ valor_inventario|floatformat:2 }}
            </span>
        </p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <form method="get" style="display: flex; gap: 0.5rem;">
            <input type="text" name="q" class="form-control" placeholder="Buscar por nombre o SKU..."
                value="{{ request.GET.q|default:'' }}">
            <button type="submit" class="btn btn-outline" style="padding: 0.75rem;">üîç</button>
            {% if request.GET.q %}
            <a href="{% url 'lista_productos' %}" class="btn btn-outline"
                style="padding: 0.75rem; color: var(--danger); border-color: var(--danger);"
                title="Limpiar b√∫squeda">‚úï</a>
            {% endif %}
        </form>
        <a href="{% url 'crear_producto' %}" class="btn btn-primary">Nuevo Producto</a>
    </div>
</div>

<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>NOMBRE</th>
                    <th>CATEGOR√çA</th>
                    <th>PRECIO</th>
                    <th>STOCK</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr>
                    <td style="font-family: monospace; font-weight: 600;">{{ p.sku }}</td>
                    <td>{{ p.nombre }}</td>
                    <td>
                        <span class="badge" style="background: #f1f5f9; color: var(--text-muted);">
                            {{ p.categoria }}
                        </span>
                    </td>
                    <td>${{ p.precio }}</td>
                    <td style="font-weight: 700;" id="stock-{{ p.pk }}"
                        class="{% if p.cantidad < 5 %}text-danger{% endif %}">
                        {{ p.cantidad }}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" onclick="openModal('{{ p.pk }}', '{{ p.nombre|escapejs }}')"
                                class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                title="Mover Stock">üîÑ</button>
                            <a href="{% url 'editar_producto' p.pk %}" class="btn btn-outline"
                                style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" title="Editar">‚úèÔ∏è</a>
                            <a href="{% url 'generar_qr' p.pk %}" target="_blank" class="btn btn-outline"
                                style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" title="Ver QR">üì±</a>
                            <a href="{% url 'eliminar_producto' p.pk %}" class="btn btn-danger"
                                style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" title="Eliminar">üóëÔ∏è</a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">No se encontraron productos.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Movement Modal -->
<div id="movementModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div
        style="background: var(--surface); padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 400px; box-shadow: var(--shadow);">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Registrar Movimiento</h2>
        <p id="modalProductName" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>

        <form id="movementForm">
            <input type="hidden" id="modalProductId">
            <div class="form-group">
                <label class="form-label">Tipo de Movimiento</label>
                <select id="modalTipo" class="form-select" required>
                    <option value="ENTRADA">Entrada</option>
                    <option value="SALIDA">Salida</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Cantidad</label>
                <input type="number" id="modalCantidad" class="form-control" min="1" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" onclick="closeModal()" class="btn btn-outline">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id, name) {
        document.getElementById('movementModal').style.display = 'flex';
        document.getElementById('modalProductId').value = id;
        document.getElementById('modalProductName').textContent = name;
        document.getElementById('modalCantidad').value = '';
        document.getElementById('modalTipo').value = 'ENTRADA';
    }

    function closeModal() {
        document.getElementById('movementModal').style.display = 'none';
    }

    document.getElementById('movementForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('modalProductId').value;
        const tipo = document.getElementById('modalTipo').value;
        const cantidad = document.getElementById('modalCantidad').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch(`/api/movimiento/${id}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ tipo, cantidad })
            });

            const data = await response.json();

            if (data.success) {
                // Update UI Row
                const stockCell = document.getElementById(`stock-${id}`);
                if (stockCell) {
                    stockCell.textContent = data.new_stock;
                    // Update text color if stock changed status (simple logic)
                    if (data.new_stock < 5) stockCell.classList.add('text-danger');
                    else stockCell.classList.remove('text-danger');
                }

                // Update Total Value Header (Requires parsing the new value)
                const totalValueElement = document.getElementById('total-inventory-value');
                if (totalValueElement && data.total_valor) {
                    totalValueElement.textContent = '$' + data.total_valor.toFixed(2);
                }

                alert(data.message);
                closeModal();
            } else {
                alert(data.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    });

    // Close modal when clicking outside
    document.getElementById('movementModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('movementModal')) {
            closeModal();
        }
    });
</script>
{% endblock %}